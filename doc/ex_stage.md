# Execute Stage 执行阶段

## Overview 概述

执行阶段（EX）实现算术逻辑运算，数值比较，存储器地址计算，跳转目标地址计算以及跳转条件的判断。其核心部件是负责算术逻辑运算的 ALU（算术逻辑单元），以及支持多种比较运算的比较器，通过对这两个核心部件输出的控制，可以实现 EX 阶段的绝大部分功能。具体模块划分及功能说明如下:

- EX 阶段模块组成  

| 模块名 | 文件名 | 说明 |
|:---:|:---:|:---|
| ex_stage | ex_stage.v | 顶层模块 |
| alu      | alu.v      | 算术逻辑模块 |
| cmp      | cmp.v      | 比较器模块 |
| ex_reg   | ex_reg.v   | 流水线寄存器 |

- 模块结构  
> ex_stage  
>    |— alu  
>    |— cmp  
>    |— ex_reg  

## EX 阶段顶层模块

EX 阶段顶层模块包括了该阶段所有子模块（包括 EX/MEM 流水线寄存器模块），其主要任务有:  

1. 连接各模块
2. 控制 EX 阶段输出
3. 判断程序流跳转（即判断是否进行无条件跳转或条件分支）
4. 计算跳转地址 PC
5. 传递其他来自译码阶段的控制、数据到流水线下一阶段


- EX 阶段顶层模块端口连线图  
![EX 阶段顶层模块端口连线图]()

端口详细信息如下:

- 时钟和复位

| 信号名 | 信号类型 | 数据类型 | 位宽 | 含义 |
| :---: | :---: | :---: | :---: | :---: |
| clk   | 输入端口 | wire    | 1   | 时钟 |
| rst   | 输入端口 | wire    | 1   | 复位 |

- 流水线寄存器

| 信号名 | 信号类型 | 数据类型 | 位宽 | 含义 |
| :---: | :---: | :---: | :---: | :--- |
| id_dst_address | 输入端口 | wire | 5   | 目的寄存器地址     |
| id_gpr_we_     | 输入端口 | wire | 1   | 通用寄存器写入有效  |
| id_mem_op      | 输入端口 | wire | 2   | 存储器操作         |
| id_mem_wr_data | 输入端口 | wire | 32  | 存储器写入数据     |
| ex_dst_address | 输出端口 | reg  | 5   | 目的寄存器地址     |
| ex_gpr_we_     | 输出端口 | reg  | 1   | 通用寄存器写入有效  |
| ex_mem_op      | 输出端口 | reg  | 2   | 存储器操作        |
| ex_mem_wr_data | 输出端口 | reg  | 32  | 存储器写入数据     |
| ex_out         | 输出端口 | wire | 32  | EX 阶段输出       |

- 运算器和比较器

| 信号名 | 信号类型 | 数据类型 | 位宽 | 含义 |
| :---: | :---: | :---: | :---: | :--- |
| alu_in0 | 输入端口 | wire | 32   | ALU 输入 |
| alu_in1 | 输入端口 | wire | 32   | ALU 输入 |
| alu_op  | 输入端口 | wire |  4   | ALU 操作 |
| cmp_in0 | 输入端口 | wire | 32   | CMP 输入 |
| cmp_in1 | 输入端口 | wire |  3   | CMP 输入 |
| cmp_op  | 输入端口 | wire | 32   | CMP 操作 |
| ex_out_sel | 输入端口 | wire | 2 | EX 输出选项 |

- 跳转判断和目标地址计算

| 信号名 | 信号类型 | 数据类型 | 位宽 | 含义 |
| :---: | :---: | :---: | :---: | :--- |
| pc_next | 输入端口 | wire | 32   | 顺序执行时下一条指令地址 |
| jump_en | 输入端口 | wire |  1   | 当前执行无条件跳转指令   |
| branch_en | 输入端口 | wire |  1 | 当前执行有条件分支指令   |
| pc_target | 输出端口 | wire |  1 | 分支跳转时下一条指令地址 |
| branch  | 输出端口 | wire |  1 | 分支跳转是否成立 |

## ALU 运算模块

ALU 模块实现两个 32 位操作数的算术/逻辑运算，输入来自 ex_stage 模块的相应输入端口，输出经过多路选择器最终至 EX/MEM 流水线寄存器。

- ALU 模块支持的运算和操作宏定义如下:

| 宏名称 | 值 | 功能 |
|:---:|:---:|:---|
| ALU_OP_NOP | 0 | 空操作（输出 0） |
| ALU_OP_AND | 1 | 按位与 |
| ALU_OP_OR  | 2 | 按位或 |
| ALU_OP_XOR | 3 | 按位异或 |
| ALU_OP_SLL | 4 | 左移 |
| ALU_OP_SRL | 5 | 右移 |
| ALU_OP_SRA | 6 | 算术右移 |
| ALU_OP_ADD | 7 | 加法 |
| ALU_OP_SUB | 8 | 减法 |

## CMP 比较模块

CMP 模块实现多种两操作数的比较运算，输出 1 位的比较结果。CMP 模块可以为 比较运算（slt 等）和有条件分支的条件判断提供支持。

- CMP 模块支持的比较运算和操作宏定义如下:

| 宏名称 | 值 | 功能 |
|:---:|:---:|:---|
| CMP_OP_NOP | 0 | 空操作（输出 0） |
| CMP_OP_EQ  | 1 | 相等比较，相等时输出 1 |
| CMP_OP_NE  | 2 | 不等比较，不等时输出 1 |
| CMP_OP_LT  | 3 | 小于比较，cmp_in0 小于 cmp_in1 时输出 1 |
| CMP_OP_LTU | 4 | 小于比较，视输入的两个数据为无符号数 |
| CMP_OP_GE  | 5 | 大于等于比较，cmp_in0 大于等于 cmp_in1 时输出 1 |
| CMP_OP_GEU | 6 | 大于等于比较，视输入的两个数据为无符号数 |
